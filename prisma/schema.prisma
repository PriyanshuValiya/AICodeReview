generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String  @id
  name          String
  email         String  @unique
  emailVerified Boolean @default(false)
  image         String?

  subscriptionTier   String  @default("FREE")
  subscriptionStatus String?

  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions     Session[]
  accounts     Account[]
  repositories Repository[]
  userUsage    UserUsage?
}

model UserUsage {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  repositoryCount Int      @default(0)
  reviewCounts    Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("user_usage")
}

model Repository {
  id                String             @id @default(cuid())
  githubId          BigInt             @unique
  name              String
  owner             String
  fullName          String
  url               String
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  reviews           Review[]
  repositoryClients RepositoryClient[]

  @@index([userId])
  @@map("repository")
}

model Review {
  id           String     @id @default(cuid())
  repositoryId String
  repository   Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  prNumber     Int
  prTitle      String
  prUrl        String
  review       String     @db.Text
  status       String     @default("completed")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([repositoryId])
  @@map("review")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Client {
  id    String @id @default(cuid())
  name  String
  email String

  repositories RepositoryClient[]

  createdAt DateTime @default(now())
}

model RepositoryClient {
  id           String    @id @default(cuid())
  repositoryId String
  clientId     String
  deliveredAt  DateTime?

  repository Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  client     Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([repositoryId, clientId])
}

